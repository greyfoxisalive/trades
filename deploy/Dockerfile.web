# Dockerfile для Web приложения
FROM node:20-alpine AS base

# Установка pnpm
RUN npm install -g pnpm@latest

WORKDIR /app

# Копирование файлов конфигурации
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY packages/shared/package.json ./packages/shared/
COPY packages/ui/package.json ./packages/ui/
COPY packages/config/package.json ./packages/config/
COPY apps/web/package.json ./apps/web/

# Установка зависимостей
RUN pnpm install --frozen-lockfile

# Копирование исходного кода
COPY packages/shared ./packages/shared
COPY packages/ui ./packages/ui
COPY packages/config ./packages/config
COPY apps/web ./apps/web
COPY tsconfig.json ./

# Сборка shared пакета (если нужен)
WORKDIR /app/packages/shared
RUN pnpm exec tsc || true

# Сборка web приложения
WORKDIR /app/apps/web
RUN pnpm build

# Production образ с Nginx
FROM nginx:alpine AS production

# Копирование собранных файлов
COPY --from=base /app/apps/web/dist /usr/share/nginx/html

# Копирование конфигурации Nginx
COPY deploy/nginx-web.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
